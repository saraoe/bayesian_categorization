# Model comparison
```{r}
# libraries
library(pacman)
pacman::p_load(
    tidyverse,
    patchwork
)
```

```{r}
# load data
sessions <- c(1, 2, 3)

for (ses in sessions) {
    pointwise_tmp <- read_csv(
        paste("data/model_comparison_pointwise_", ses, ".csv", sep = "")
    ) %>%
        mutate(
            trial = rep(
                seq_len(104),
                length(unique(subject)) * length(unique(model))
            ),
            condition = ifelse(subject > 100, 2, 1)
        )
    pointwise_tmp$session <- ses

    if (exists("pointwise_df")) {
        pointwise_df <- rbind(pointwise_df, pointwise_tmp)
    } else {
        pointwise_df <- pointwise_tmp
    }

    compare_tmp <- read_csv(
        paste("data/model_comparison_compare_", ses, ".csv", sep = "")
    ) %>%
        mutate(
            condition = ifelse(subject > 100, 2, 1)
        )
    compare_tmp$session <- ses

    if (exists("compare_df")) {
        compare_df <- rbind(compare_df, compare_tmp)
    } else {
        compare_df <- compare_tmp
    }
}

# add model names for plotting and NA for inf pareto k values
model_names <- list(
    "gcm" = "GCM",
    "rl" = "RL Assymetrical",
    "rl_simple" = "RL Simple"
)

pointwise_df <- pointwise_df %>%
    mutate(
        model_name = as.character(model_names[model]),
        influence_pareto_k = ifelse(
            is.infinite(influence_pareto_k), NA, influence_pareto_k
        )
    )

# add model names instead of numbers
model_number <- list(
    "1" = "gcm",
    "2" = "rl",
    "3" = "rl_simple"
)

colnames(compare_df) <- c(
    "model", colnames(compare_df)[2:ncol(compare_df)]
)
compare_df <- compare_df %>%
    mutate(
        model = str_extract(model, "\\d"),
        model = as.character(model_number[model]),
        model_name = as.character(model_names[model])
    )
```

## PSIS diagnostic
```{r}
pointwise_df <- pointwise_df %>% 
    mutate(
        critical_psis = ifelse(
            influence_pareto_k > .7 | is.na(influence_pareto_k),
            1, 0
        )
    )

pointwise_df %>%
    group_by(model) %>%
    summarize(
        sum(critical_psis) / n()
    )
```

```{r}
ggplot(data = pointwise_df) +
    geom_point(aes(x = trial, y = influence_pareto_k, color = model_name),
        alpha = .2
    ) +
    geom_hline(
        yintercept = 0,
        linetype = "dashed", linewidth = 1
    ) +
    geom_hline(
        yintercept = 0.5,
        linetype = "dashed", linewidth = 1
    ) +
    geom_hline(
        yintercept = 0.7,
        linetype = "dashed", linewidth = 1
    ) +
    theme_bw() +
    labs(
        x = "",
        y = "Pareto k",
        color = "Model"
    ) +
    scale_color_brewer(palette = "Dark2")

ggsave("figs/model_comparison/psis_diagnostics.png",
    width = 7, height = 7
)
```

```{r}
ggplot(data = pointwise_df) +
    geom_point(aes(x = trial, y = influence_pareto_k, color = model_name),
        alpha = .5
    ) +
    facet_wrap(. ~ subject) +
    geom_hline(
        yintercept = 0,
        linetype = "dashed", linewidth = 1
    ) +
    geom_hline(
        yintercept = 0.5,
        linetype = "dashed", linewidth = 1
    ) +
    geom_hline(
        yintercept = 0.7,
        linetype = "dashed", linewidth = 1
    ) +
    theme_bw() +
    labs(
        x = "",
        y = "Pareto k",
        color = "Model"
    ) +
    scale_color_brewer(palette = "Dark2")

ggsave("figs/model_comparison/psis_diagnostics_subject.png",
    width = 7
)
```

## compare
```{r}
compare_df <- compare_df %>%
    group_by(condition, session, subject) %>%
    mutate(
        model_rank = ifelse(
            looic == min(looic), 1,
            ifelse(looic == max(looic), 3, 2)
        )
    )

compare_df %>%
    group_by(condition, session, model) %>%
    summarize(
        mean(model_rank == 1),
        sum(model_rank == 1)
    )
```

```{r}
p1 <- compare_df %>%
    filter(condition == 1) %>%
    ggplot() +
    geom_density(aes(x = looic, fill = model_name),
                 alpha = .5) +
    facet_wrap(. ~ session) +
    theme_bw() +
    scale_fill_brewer(palette = "Dark2") +
    labs(
        fill = "Model",
        title = "A) Condition 1")

p2 <- compare_df %>%
    filter(condition == 2) %>%
    ggplot() +
    geom_density(aes(x = looic, fill = model_name),
                 alpha = .5) +
    facet_wrap(. ~ session) +
    theme_bw() +
    scale_fill_brewer(palette = "Dark2") +
    labs(
        fill = "Model",
        title = "B) Condition 2")

p1 / p2 +
  plot_layout(guides = "collect")

ggsave("figs/model_comparison/looic_distributions.png",
       width = 7, height = 7)
```

## elpd diff
```{r}
elpd_diff <- pointwise_df %>%
    select(c(elpd_loo, model, trial, subject, condition, session)) %>%
    pivot_wider(names_from = model, values_from = elpd_loo) %>%
    mutate(
        rl_asym_rl_simple_diff = rl - rl_simple,
        rl_asym_gcm_diff = rl - gcm,
        rl_simple_gcm_diff = rl_simple - gcm,
        session = as.factor(session)
    )
```

```{r}
ggplot(data = elpd_diff) +
    geom_point(aes(x = trial, y = rl_asym_rl_simple_diff, color = session),
        alpha = .5
    ) +
    geom_hline(
        yintercept = 0, color = "black",
        linetype = "dashed", linewidth = 1
    ) +
    facet_wrap(. ~ condition) +
    theme_bw() +
    labs(
        x = "",
        y = "elpd difference"
    ) +
    scale_color_brewer(palette = "Dark2")

ggsave("figs/model_comparison/elpd_diff_rl_asym_rl_simple.png",
    width = 7, height = 5
)
```

```{r}
ggplot(data = elpd_diff) +
    geom_point(aes(x = trial, y = rl_asym_gcm_diff, color = session),
        alpha = .5
    ) +
    geom_hline(
        yintercept = 0, color = "black",
        linetype = "dashed", linewidth = 1
    ) +
    facet_wrap(. ~ condition) +
    theme_bw() +
    labs(
        x = "",
        y = "elpd difference"
    ) +
    scale_color_brewer(palette = "Dark2")

ggsave("figs/model_comparison/elpd_diff_rl_asym_gcm.png",
    width = 7, height = 5
)
```

```{r}
ggplot(data = elpd_diff) +
    geom_point(aes(x = trial, y = rl_simple_gcm_diff, color = session),
        alpha = .5
    ) +
    geom_hline(
        yintercept = 0, color = "black",
        linetype = "dashed", linewidth = 1
    ) +
    facet_wrap(. ~ condition) +
    theme_bw() +
    labs(
        x = "",
        y = "elpd difference"
    ) +
    scale_color_brewer(palette = "Dark2")

ggsave("figs/model_comparison/elpd_diff_rl_simple_gcm.png",
    width = 7, height = 5
)
```